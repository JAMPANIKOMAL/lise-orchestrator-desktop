<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #log { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: auto; background: #f9f9f9; }
        button { margin: 5px; padding: 10px; }
    </style>
</head>
<body>
    <h1>WebSocket Connection Test</h1>
    <button onclick="connectWebSocket()">Connect</button>
    <button onclick="disconnectWebSocket()">Disconnect</button>
    <button onclick="clearLog()">Clear Log</button>
    <div id="log"></div>

    <script>
        let socket = null;

        function addLog(message) {
            const log = document.getElementById('log');
            const div = document.createElement('div');
            div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        function connectWebSocket() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                addLog('WebSocket is already connected');
                return;
            }

            const wsUrl = 'ws://localhost:8000/ws/log-stream';
            addLog(`Attempting to connect to ${wsUrl}`);
            
            try {
                socket = new WebSocket(wsUrl);

                socket.onopen = () => {
                    addLog('--- Log stream connected ---');
                };
                
                socket.onmessage = (event) => {
                    addLog(`Received: ${event.data}`);
                };
                
                socket.onclose = (event) => {
                    if (event.wasClean) {
                        addLog('--- Log stream disconnected cleanly ---');
                    } else {
                        addLog(`--- Log stream disconnected unexpectedly (code: ${event.code}, reason: ${event.reason}) ---`);
                    }
                };
                
                socket.onerror = (event) => {
                    let errorMsg = 'WebSocket Error: ';
                    if (event && event.target && event.target.readyState !== undefined) {
                        switch (event.target.readyState) {
                            case WebSocket.CONNECTING:
                                errorMsg += 'Connection attempt failed';
                                break;
                            case WebSocket.OPEN:
                                errorMsg += 'Connection error during communication';
                                break;
                            case WebSocket.CLOSING:
                                errorMsg += 'Connection closing with error';
                                break;
                            case WebSocket.CLOSED:
                                errorMsg += 'Connection failed to establish';
                                break;
                            default:
                                errorMsg += 'Unknown connection state';
                        }
                    } else {
                        errorMsg += 'Connection failed - server may not be running';
                    }
                    addLog(errorMsg);
                    console.error('WebSocket Error:', event);
                };
            } catch (error) {
                addLog(`WebSocket Error: Failed to create connection - ${error.message}`);
                console.error('WebSocket creation failed:', error);
            }
        }

        function disconnectWebSocket() {
            if (socket) {
                socket.close();
                socket = null;
                addLog('WebSocket connection closed manually');
            } else {
                addLog('No WebSocket connection to close');
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // Auto-connect on page load
        document.addEventListener('DOMContentLoaded', () => {
            addLog('Page loaded - ready to test WebSocket connection');
        });
    </script>
</body>
</html>
